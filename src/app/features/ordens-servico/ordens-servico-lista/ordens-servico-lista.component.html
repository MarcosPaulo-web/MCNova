<!-- src/app/features/ordens-servico/ordens-servico-lista/ordens-servico-lista.component.html -->
<div class="ordens-page">
  <!-- Cabeçalho -->
  <div class="page-header">
    <div>
      <h2>
        <i class="bi bi-file-earmark-text me-2"></i>
        Ordens de Serviço
      </h2>
      <p class="text-muted mb-0">Gerenciamento de ordens de serviço e orçamentos</p>
    </div>
    
    <button class="btn btn-primary" (click)="abrirModalNovo()">
      <i class="bi bi-plus-circle me-2"></i>
      Nova Ordem
    </button>
  </div>
  
  <!-- Filtros de Status -->
  <div class="filters-bar card">
    <div class="card-body">
      <div class="status-filters">
        @for (status of statusOptions; track status.value) {
          <button
            type="button"
            class="btn btn-sm"
            [class]="'btn-' + status.class"
            [class.active]="filtroStatus() === status.value"
            (click)="alterarFiltroStatus(status.value)"
          >
            {{ status.label }}
          </button>
        }
      </div>
    </div>
  </div>
  
  <!-- Loading State -->
  @if (isLoading()) {
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Carregando...</span>
      </div>
      <p class="text-muted mt-2">Carregando ordens...</p>
    </div>
  } @else {
    <!-- Tabela de Ordens -->
    <div class="card">
      <div class="card-body">
        @if (ordensFiltradas().length === 0) {
          <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <p>Nenhuma ordem encontrada</p>
          </div>
        } @else {
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead>
                <tr>
                  <th>DATA</th>
                  <th>CLIENTE</th>
                  <th>VEÍCULO</th>
                  <th>TIPO</th>
                  <th>STATUS</th>
                  <th>TOTAL</th>
                  <th class="text-center">AÇÕES</th>
                </tr>
              </thead>
              <tbody>
                @for (ordem of ordensFiltradas(); track ordem.cdOrdemServico) {
                  <tr>
                    <td>
                      <small>{{ formatarDataHora(ordem.dataAbertura) }}</small>
                    </td>
                    <td>{{ getClienteNome(ordem) }}</td>
                    <td>
                      <span class="placa">{{ ordem.placaVeiculo || '-' }}</span>
                      <br>
                      <small class="text-muted">{{ ordem.modeloVeiculo || '-' }}</small>
                    </td>
                    <td>
                      @if (ordem.tipoOrdemOrcamento === 'ORCAMENTO') {
                        <span class="badge bg-info">ORÇAMENTO</span>
                      } @else {
                        <span class="badge bg-primary">OS</span>
                      }
                    </td>
                    <!-- ✅ Dropdown de Status Clicável -->
                    <td>
                      <div class="status-dropdown-container">
                        <span 
                          class="badge status-clickable" 
                          [ngClass]="getStatusClass(ordem.status)"
                          (click)="toggleDropdownStatus(ordem.cdOrdemServico, $event)"
                          title="Clique para alterar o status"
                        >
                          {{ getStatusLabel(ordem.status) }}
                          <i class="bi bi-chevron-down ms-1"></i>
                        </span>
                        
                        <!-- Dropdown Menu -->
                        @if (isDropdownAberto(ordem.cdOrdemServico)) {
                          <div class="status-dropdown-menu">
                            @for (statusOpt of statusDropdownOptions; track statusOpt.value) {
                              <div 
                                class="status-dropdown-item"
                                [class.active]="ordem.status === statusOpt.value"
                                (click)="mudarStatus(ordem, statusOpt.value, $event)"
                              >
                                <i class="bi bi-{{ statusOpt.icon }} me-2" [class]="'text-' + statusOpt.class"></i>
                                <span>{{ statusOpt.label }}</span>
                                @if (ordem.status === statusOpt.value) {
                                  <i class="bi bi-check2 ms-auto text-success"></i>
                                }
                              </div>
                            }
                          </div>
                        }
                      </div>
                    </td>
                    <td>
                      <strong class="text-success">{{ formatarMoeda(ordem.vlTotal) }}</strong>
                    </td>
                    <td class="text-center">
                      <div class="btn-group btn-group-sm">
                        <!-- Editar -->
                        @if (ordem.status === 'AGENDADO') {
                          <button
                            class="btn btn-outline-info"
                            (click)="abrirModalEditar(ordem)"
                            title="Editar"
                          >
                            <i class="bi bi-pencil"></i>
                          </button>
                        }
                        
                        <!-- Aprovar Orçamento -->
                        @if (ordem.tipoOrdemOrcamento === 'ORCAMENTO' && ordem.status === 'AGENDADO' && !ordem.aprovado) {
                          <button
                            class="btn btn-outline-success"
                            (click)="abrirModalAprovar(ordem)"
                            title="Aprovar Orçamento"
                          >
                            <i class="bi bi-check-circle"></i>
                          </button>
                        }
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
          
          <!-- Rodapé com Total -->
          <div class="table-footer">
            <span class="text-muted">
              Total: <strong>{{ ordensFiltradas().length }}</strong> ordem(ns)
            </span>
          </div>
        }
      </div>
    </div>
  }
</div>

<!-- ========================================== -->
<!-- MODAL DE CRIAR ORDEM -->
<!-- ========================================== -->
<div class="modal fade" #ordemModal tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-file-earmark-plus me-2"></i>
          Nova Ordem de Serviço
        </h5>
        <button type="button" class="btn-close" (click)="fecharModal()"></button>
      </div>
      
      <form [formGroup]="ordemForm" (ngSubmit)="salvar()">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12">
              <h6 class="section-title">
                <i class="bi bi-info-circle me-2"></i>
                Informações Básicas
              </h6>
            </div>
            
            <!-- ✅ CORRIGIDO: tipoOrdemOrcamento -->
            <div class="col-md-3">
              <label for="tipoOrdemOrcamento" class="form-label">
                Tipo <span class="text-danger">*</span>
              </label>
              <select
                class="form-select"
                id="tipoOrdemOrcamento"
                formControlName="tipoOrdemOrcamento"
              >
                @for (tipo of tiposServico; track tipo.value) {
                  <option [value]="tipo.value">{{ tipo.label }}</option>
                }
              </select>
            </div>
            
            <div class="col-md-3">
              <label for="cdCliente" class="form-label">
                Cliente <span class="text-danger">*</span>
              </label>
              <select
                class="form-select"
                id="cdCliente"
                formControlName="cdCliente"
              >
                <option value="">Selecione o cliente</option>
                @for (cliente of clientes(); track cliente.cdCliente) {
                  <option [value]="cliente.cdCliente">{{ cliente.nmCliente }}</option>
                }
              </select>
            </div>
            
            <div class="col-md-3">
              <label for="cdVeiculo" class="form-label">
                Veículo <span class="text-danger">*</span>
              </label>
              <select
                class="form-select"
                id="cdVeiculo"
                formControlName="cdVeiculo"
                [disabled]="!ordemForm.get('cdCliente')?.value"
              >
                <option value="">Selecione o veículo</option>
                @for (veiculo of veiculosCliente(); track veiculo.cdVeiculo) {
                  <option [value]="veiculo.cdVeiculo">
                    {{ veiculo.placa }} - {{ veiculo.modelo }}
                  </option>
                }
              </select>
            </div>

            <div class="col-md-3">
              <label for="cdMecanico" class="form-label">
                Mecânico <span class="text-danger">*</span>
              </label>
              <select
                class="form-select"
                id="cdMecanico"
                formControlName="cdMecanico"
              >
                <option value="">Selecione o mecânico</option>
                @for (mecanico of mecanicos(); track mecanico.cdUsuario) {
                  <option [value]="mecanico.cdUsuario">{{ mecanico.nmUsuario }}</option>
                }
              </select>
            </div>

            <div class="col-md-4">
              <label for="dataAgendamento" class="form-label">
                Data de Agendamento
                @if (ordemForm.get('tipoOrdemOrcamento')?.value === 'ORDEM_DE_SERVICO') {
                  <span class="text-danger">*</span>
                }
              </label>
              <input
                type="date"
                class="form-control"
                id="dataAgendamento"
                formControlName="dataAgendamento"
              />
            </div>
            
            <!-- Produtos -->
            <div class="col-12 mt-4">
              <h6 class="section-title">
                <i class="bi bi-box-seam me-2"></i>
                Produtos
              </h6>
            </div>
            
            <div class="col-12">
              <div class="card bg-light">
                <div class="card-body">
                  <div class="row g-2">
                    <div class="col-md-6">
                      <select
                        class="form-select"
                        [(ngModel)]="produtoSelecionado"
                        [ngModelOptions]="{standalone: true}"
                      >
                        <option [ngValue]="null">Selecione um produto</option>
                        @for (produto of produtos(); track produto.cdProduto) {
                          <option [ngValue]="produto.cdProduto">
                            {{ produto.nmProduto }} - {{ formatarMoeda(produto.vlProduto) }} (Est: {{ produto.qtdEstoque }})
                          </option>
                        }
                      </select>
                    </div>
                    <div class="col-md-3">
                      <input
                        type="number"
                        class="form-control"
                        placeholder="Quantidade"
                        min="1"
                        [(ngModel)]="quantidadeProduto"
                        [ngModelOptions]="{standalone: true}"
                      />
                    </div>
                    <div class="col-md-3">
                      <button
                        type="button"
                        class="btn btn-success w-100"
                        (click)="adicionarProduto()"
                      >
                        <i class="bi bi-plus-circle me-1"></i>
                        Adicionar
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Serviços -->
            <div class="col-12 mt-3">
              <h6 class="section-title">
                <i class="bi bi-tools me-2"></i>
                Serviços
              </h6>
            </div>
            
            <div class="col-12">
              <div class="card bg-light">
                <div class="card-body">
                  <div class="row g-2">
                    <div class="col-md-9">
                      <select
                        class="form-select"
                        [(ngModel)]="servicoSelecionado"
                        [ngModelOptions]="{standalone: true}"
                      >
                        <option [ngValue]="null">Selecione um serviço</option>
                        @for (servico of servicos(); track servico.cdServico) {
                          <option [ngValue]="servico.cdServico">
                            {{ servico.nmServico }} - {{ formatarMoeda(servico.vlServico) }}
                          </option>
                        }
                      </select>
                    </div>
                    <div class="col-md-3">
                      <button
                        type="button"
                        class="btn btn-success w-100"
                        (click)="adicionarServico()"
                      >
                        <i class="bi bi-plus-circle me-1"></i>
                        Adicionar
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Itens Adicionados -->
            <div class="col-12 mt-3">
              @if (itens().length > 0) {
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Tipo</th>
                        <th>Item</th>
                        <th>Preço Unit.</th>
                        <th>Qtd</th>
                        <th>Subtotal</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (item of itens(); track item.codigo + item.tipo) {
                        <tr>
                          <td>
                            @if (item.tipo === 'produto') {
                              <span class="badge bg-info">Produto</span>
                            } @else {
                              <span class="badge bg-primary">Serviço</span>
                            }
                          </td>
                          <td>{{ item.nome }}</td>
                          <td>{{ formatarMoeda(item.vlUnitario) }}</td>
                          <td>{{ item.quantidade }}</td>
                          <td><strong>{{ formatarMoeda(item.vlTotal) }}</strong></td>
                          <td class="text-end">
                            <button
                              type="button"
                              class="btn btn-sm btn-outline-danger"
                              (click)="removerItem(item.tipo, item.codigo)"
                              title="Remover"
                            >
                              <i class="bi bi-trash"></i>
                            </button>
                          </td>
                        </tr>
                      }
                      <!-- ✅ MÃO DE OBRA EXTRA -->
                      <tr class="table-warning">
                        <td colspan="2"><strong>Mão de Obra Extra</strong></td>
                        <td colspan="3">
                          <div class="input-group input-group-sm">
                            <span class="input-group-text">R$</span>
                            <input
                              type="number"
                              class="form-control"
                              formControlName="vlMaoObraExtra"
                              min="0"
                              step="0.01"
                            />
                          </div>
                        </td>
                        <td></td>
                      </tr>
                    </tbody>
                    <tfoot>
                      <tr class="table-primary">
                        <th colspan="4" class="text-end">TOTAL:</th>
                        <th colspan="2">
                          <h5 class="mb-0 text-success">{{ formatarMoeda(calcularTotal()) }}</h5>
                        </th>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              } @else {
                <div class="alert alert-info">
                  <i class="bi bi-info-circle me-2"></i>
                  Adicione produtos e/ou serviços à ordem
                </div>
              }
            </div>
            
            <!-- Diagnóstico -->
            <div class="col-12 mt-3">
              <label for="diagnostico" class="form-label">Diagnóstico</label>
              <textarea
                class="form-control"
                id="diagnostico"
                formControlName="diagnostico"
                rows="2"
                placeholder="Diagnóstico inicial do veículo..."
              ></textarea>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="fecharModal()"
            [disabled]="isSubmitting()"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="isSubmitting() || itens().length === 0"
          >
            @if (isSubmitting()) {
              <span class="spinner-border spinner-border-sm me-2"></span>
              Salvando...
            } @else {
              <i class="bi bi-check-circle me-2"></i>
              Criar Ordem
            }
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ========================================== -->
<!-- MODAL DE APROVAÇÃO -->
<!-- ========================================== -->
<div class="modal fade" #aprovarModal tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-check-circle me-2"></i>
          Aprovar Orçamento
        </h5>
        <button type="button" class="btn-close" (click)="aprovarModalInstance?.hide()"></button>
      </div>
      
      <form [formGroup]="aprovarForm" (ngSubmit)="aprovarOrcamento()">
        <div class="modal-body">
          <p class="text-muted mb-3">
            Ao aprovar este orçamento, ele será transformado em Ordem de Serviço e será criado um agendamento automaticamente.
          </p>
          
          <div class="mb-3">
            <label for="dataAgendamentoAprovar" class="form-label">
              Data de Agendamento <span class="text-danger">*</span>
            </label>
            <input
              type="date"
              class="form-control"
              id="dataAgendamentoAprovar"
              formControlName="dataAgendamento"
            />
          </div>
          
          @if (ordemParaAprovar()) {
            <div class="alert alert-info">
              <strong>Cliente:</strong> {{ ordemParaAprovar()?.nmCliente }}<br>
              <strong>Veículo:</strong> {{ ordemParaAprovar()?.placaVeiculo }}<br>
              <strong>Total:</strong> {{ formatarMoeda(ordemParaAprovar()!.vlTotal) }}
            </div>
          }
        </div>
        
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="aprovarModalInstance?.hide()"
            [disabled]="isSubmitting()"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="btn btn-success"
            [disabled]="isSubmitting()"
          >
            @if (isSubmitting()) {
              <span class="spinner-border spinner-border-sm me-2"></span>
              Aprovando...
            } @else {
              <i class="bi bi-check-circle me-2"></i>
              Aprovar Orçamento
            }
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ========================================== -->
<!-- MODAL DE EDIÇÃO -->
<!-- ========================================== -->
<div class="modal fade" #editarModal tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-pencil me-2"></i>
          Editar Ordem de Serviço
        </h5>
        <button type="button" class="btn-close" (click)="editarModalInstance?.hide()"></button>
      </div>
      
      <form [formGroup]="editarForm" (ngSubmit)="salvarEdicao()">
        <div class="modal-body">
          @if (ordemParaEditar()) {
            <div class="alert alert-info mb-3">
              <strong>OS #{{ ordemParaEditar()?.cdOrdemServico }}</strong><br>
              <strong>Cliente:</strong> {{ ordemParaEditar()?.nmCliente }}<br>
              <strong>Veículo:</strong> {{ ordemParaEditar()?.placaVeiculo }}<br>
              <strong>Status:</strong> {{ getStatusLabel(ordemParaEditar()!.status) }}
            </div>
          }
          
          <!-- ✅ MÃO DE OBRA EXTRA -->d
          <div class="mb-3">
            <label for="editVlMaoObraExtra" class="form-label">
              Mão de Obra Extra (R$)
            </label>
            <div class="input-group">
              <span class="input-group-text">R$</span>
              <input
                type="number"
                class="form-control"
                id="editVlMaoObraExtra"
                formControlName="vlMaoObraExtra"
                min="0"
                step="0.01"
              />
            </div>
          </div>
          
          <div class="mb-3">
            <label for="editDiagnostico" class="form-label">Diagnóstico</label>
            <textarea
              class="form-control"
              id="editDiagnostico"
              formControlName="diagnostico"
              rows="3"
            ></textarea>
          </div>
        </div>
        
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="editarModalInstance?.hide()"
            [disabled]="isSubmitting()"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="isSubmitting()"
          >
            @if (isSubmitting()) {
              <span class="spinner-border spinner-border-sm me-2"></span>
              Salvando...
            } @else {
              <i class="bi bi-check-circle me-2"></i>
              Salvar
            }
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ========================================== -->
<!-- ✅ MODAL DE CONCLUSÃO COM FORMA DE PAGAMENTO -->
<!-- ========================================== -->
<div class="modal fade" #concluirModal tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-check-circle me-2"></i>
          Concluir Ordem de Serviço
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="concluirModalInstance?.hide()"></button>
      </div>
      
      <form [formGroup]="concluirForm" (ngSubmit)="concluirOrdem()">
        <div class="modal-body">
          @if (ordemParaConcluir(); as ordem) {
            <div class="alert alert-info">
              <strong>OS #{{ ordem.cdOrdemServico }}</strong><br>
              <strong>Cliente:</strong> {{ ordem.nmCliente }}<br>
              <strong>Veículo:</strong> {{ ordem.placaVeiculo }}<br>
              <strong>Total:</strong> <span class="text-success fw-bold">{{ formatarMoeda(ordem.vlTotal) }}</span>
            </div>
          }
          
          <div class="mb-3">
            <label for="formaPagamento" class="form-label">
              Forma de Pagamento <span class="text-danger">*</span>
            </label>
            <select
              class="form-select form-select-lg"
              id="formaPagamento"
              formControlName="formaPagamento"
              required
            >
              <option value="">Selecione a forma de pagamento</option>
              @for (forma of formasPagamento; track forma.value) {
                <option [value]="forma.value">{{ forma.label }}</option>
              }
            </select>
          </div>
          
          <div class="alert alert-warning">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Atenção:</strong> Ao concluir, o faturamento será gerado automaticamente e não poderá ser desfeito.
          </div>
        </div>
        
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="concluirModalInstance?.hide()"
            [disabled]="isSubmitting()"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="btn btn-success"
            [disabled]="isSubmitting() || concluirForm.invalid"
          >
            @if (isSubmitting()) {
              <span class="spinner-border spinner-border-sm me-2"></span>
              Concluindo...
            } @else {
              <i class="bi bi-check-circle me-2"></i>
              Concluir e Faturar
            }
          </button>
        </div>
      </form>
    </div>
  </div>
</div>